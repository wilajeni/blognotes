---
title: "Tidyverse"
author: "Jiawen Li"
date: "2023-02-07"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r, message=FALSE}
#install.packages("gapminder")
#install.packages("dplyr")
library(gapminder)
library(dplyr)
library(ggplot2)
```

## Tidyverse
1. {dplyr}
  a. Verbs: filter(like subset), arrange(like order), 
  b. mutate, select(choose column), transmute(select and calculate new column), rename(newname=oldname)
  c. summarize(output 1 row tibble), group_by(make summarize output each row), count(# of specific var)
  d. glimpse(str() for big tibbles)
2. {ggplot2} 
  a. aesthetic up to 4 dimensions(x,y,color,size)
  b. layers: 
    geom_point()-x,y, 
    geom_line()-x,y, 
    geom_col()-x,y, 
    geom_histogram(binwidth=,bins=)-x
    geom_boxplot()-x,y. x is category(# of boxes), y is numerical obs.
  C. scale_x_log10(), facet_wrap(~year), expand_limits(y=0)
3. Other Packages: forcats, tibble, readr, stringr, tidyr, purrr

```{r}
gapminder
class(gapminder)
```

### dplyr verbs

#### Pipe and filter
pipe %>% is in package dplyr.
filter() is in package dplyr.
```{r}
# Filter the gapminder dataset for the year 1957
gapminder %>% filter(year == 1957)
gapminder %>% filter(country %in% c("China","India"), year %in% 1952:1972)
```

#### arrange {dplyr}
arrange(var) orders the rows of a data frame by the values of selected columns.
arrange(desc(var))
```{r}
gapminder %>% arrange(desc(pop))
gapminder %>% filter(year==2007) %>% arrange(desc(gdpPercap))
```

#### mutate {dplyr}
mutate() creates new columns that are functions of existing variables. It can also modify (if the name is the same as an existing column) and delete columns (by setting their value to NULL).
*group mutate vs summarize*
```{r}
gapminder %>% mutate(gdpinbil = pop * gdpPercap/1000000000)
gapminder %>% mutate(gdp = pop * gdpPercap) %>% filter(year == 2007) %>% arrange(desc(gdp))
# group mutate, group summarize value added to each row
gapminder %>% group_by(country,year) %>% mutate(avgle=mean(lifeExp))
```

#### group_by {dplyr} and summarise {dplyr}
summarise() and summarize() are synonyms.
summarise(var1=func1,var2=func2...) creates a new data frame.
Useful functions:
- Center: mean(), median()
- Spread: sd(), IQR(), mad()
- Range: min(), max(),
- Position: first(), last(), nth(),
- Count: n(), n_distinct()*no parameter passed*
- Logical: any(), all()
group_by() takes an existing tbl and converts it into a grouped tbl where operations are performed "by group". ungroup() removes grouping.

```{r}
gapminder %>% group_by(continent,country) %>%
  summarise(meanlife=mean(lifeExp),maxlife=max(lifeExp))
```

#### slice {dplyr}
slice_head() and slice_tail() select the first or last rows. slice_sample() randomly selects rows. slice_min() and slice_max() select rows with highest or lowest values of a variable.
```{r}
gapminder %>% filter(year==2007) %>% slice_max(pop,n=5)
gapminder %>% group_by(continent) %>% slice_max(pop,n=3)
```


#### select {dplyr}
Select (and optionally rename) variables in a data frame, using a concise mini-language that makes it easy to refer to variables based on their name (e.g. a:f selects all columns from a on the left to f on the right) or type (e.g. where(is.numeric) selects all numeric columns).
```{r}
gapminder %>% select(country:year)
gapminder %>% select(-(country:year))
gapminder %>% select(country,contains("e"))
gapminder %>% select(starts_with("co"))
```


#### count {dplyr}
count the unique values of one or more variables: df %>% count(a, b) is roughly equivalent to df %>% group_by(a, b) %>% summarise(n = n()). count() is paired with tally(), a lower-level helper that is equivalent to df %>% summarise(n = n()). Supply wt to perform weighted counts, switching the summary from n = n() to n = sum(wt).
```{r}
gapminder %>% count(country)
gapminder %>% count(country,wt = pop,sort = TRUE)
```


### ggplot2-ggplot

#### mapping = aesthetics
x,y,color and size(4 dimensions)
label,fill,(alpha & shape for points)
```{r}
gapminder_2007 <- gapminder %>% filter(year == 2007)
# gapminder_2007 <- subset(gapminder,year == 2007)
# ggplot(gapminder_2007,aes(gdpPercap,lifeExp)) + geom_point()
ggplot(gapminder_2007,aes(x=gdpPercap,y=lifeExp, color=continent,size=pop)) + geom_point() + scale_x_log10()
```

#### layers: geom_** 48 TOTAL
modify aes in geom_** should not use mapping, pass it as attributes
- row.names(df)
```{r}
ggplot(mtcars, aes(wt, mpg, color = factor(cyl))) + geom_point(shape=1,size=4)
```
Scatter Plots: geom_points, geom_jitter/abline/smooth/count
Histogram: geom_histogram
Bar Plots: geom_bar()=count # of obs at x; geom_col()=plot actual values

#### position & axis limits
```{r}
ggplot(mtcars, aes(mpg,0)) +
  geom_jitter() +
  # Set the y-axis limits
  ylim(c(-2,2))
```


#### faceting
facet_grid():vertical alignment
facet_wrap():proportional arrangement
```{r}
ggplot(gapminder_2007,aes(x=pop,y=lifeExp))+geom_point()+scale_x_log10()+facet_wrap(~continent)
```
```{r}
ggplot(gapminder,aes(x=gdpPercap,y=lifeExp,color=continent,size=pop))+geom_point()+scale_x_log10()+facet_grid(~year)
```

#### plot summary data
expand_limits(y=0)
```{r}
# Summarize medianGdpPercap within each continent within each year: by_year_continent
by_year_continent <- gapminder %>% group_by(continent, year) %>% summarise(medianGdpPercap=median(gdpPercap))

# Plot the change in medianGdpPercap in each continent over time
ggplot(by_year_continent, aes(x=year,y=medianGdpPercap,color=continent))+geom_point()+expand_limits(y=0)

```

#### labels and titles
labs(x=,y=,title=,subtitle=,caption="rightbottom")
<=>xlab(),ylab(),ggtitle()
```{r}
plota <- ggplot(by_year_continent, aes(x=year,y=medianGdpPercap,color=continent))+geom_point()+expand_limits(y=0)

plota+labs(title = "AAA",x="CCC",y="DDD")

plota+ggtitle("BBB")
```

#### trend line geom_smooth()
geom_smooth(method = NULL,se = TRUE)

#### explicit plot factor
```{r}
# Change the command below so that cyl is treated as factor
ggplot(mtcars, aes(factor(cyl), mpg)) +
  geom_point()
```

